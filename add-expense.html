<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <title>Group Pay with Receipt Selection</title>

    <style>
        /* Add some styles for animation */
        .receipt-uploaded {
            animation: receiptSlideIn 1s ease-out;
        }
        @keyframes receiptSlideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading animation for OCR processing */
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <!-- Expense Detail -->
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Group Pay: Split the Bill</h5>
                <!-- Input for sending link -->
                <div class="mb-3 mt-4">
                    <label for="contactInput" class="form-label">Send Link To (Email/Phone)</label>
                    <input type="text" class="form-control" id="contactInput" placeholder="Enter email or phone number">
                </div>
                <button class="btn btn-secondary" id="sendLinkBtn">Send Link</button>
                <div id="linkStatus" class="mt-2"></div>

                <p class="card-text">Upload a receipt, and select your order items.</p>

                <!-- Receipt Upload or Take a Picture -->
                <div class="mb-3">
                    <label for="receiptUpload" class="form-label">Upload or Take a Picture of the Receipt</label>
                    <input class="form-control" type="file" id="receiptUpload" accept="image/*" capture="environment">
                </div>

                <!-- Loading Spinner (simulates OCR processing) -->
                <div id="loadingSpinner" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p>Scanning receipt, please wait...</p>
                </div>

                <!-- Display extracted items (added dynamically) -->
                <div id="receiptItems" class="receipt-uploaded"></div>

                <!-- Tip Input -->
                <div class="mb-3">
                    <label for="tipInput" class="form-label">Add Tip (optional)</label>
                    <input type="number" class="form-control" id="tipInput" placeholder="Enter tip amount in dollars" value="0">
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="groupPayBtn">Submit Selections</button>
                </div>

                <!-- Display group selections -->
                <h4 class="mt-4">Group Selections:</h4>
                <div id="groupSelections"></div>
                
                <!-- Display Total Amount -->
                <h4 class="mt-4">Total Amount Owed:</h4>
                <div id="totalAmount" class="h5 text-success"></div>

            </div>
        </div>
    </div>

    <!-- JS and Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
    <script>
        const receiptUpload = document.getElementById("receiptUpload");
        const receiptItems = document.getElementById("receiptItems");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const groupSelections = document.getElementById("groupSelections");
        const totalAmount = document.getElementById("totalAmount");
        const tipInput = document.getElementById("tipInput");
        const contactInput = document.getElementById("contactInput");
        const linkStatus = document.getElementById("linkStatus");

        let itemPrices = {}; // Store prices of items

        // Handle file upload and process with Tesseract OCR
        receiptUpload.addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                // Show the loading spinner
                loadingSpinner.classList.add("show");

                // Initialize Tesseract.js to recognize text from the image
                Tesseract.recognize(
                    file,
                    'eng',
                    {
                        logger: function(m) { console.log(m); } // Log progress
                    }
                ).then(({ data: { text } }) => {
                    // Hide loading spinner
                    loadingSpinner.classList.remove("show");

                    // Simulate text extraction result (Example: "Item - $price")
                    const items = text.split("\n").filter(item => item.trim() !== "");

                    // Clear existing items
                    receiptItems.innerHTML = "";

                    // Dynamically add checkboxes for each item with prices
                    items.forEach((item, index) => {
                        const parts = item.split('-'); // Assume format "Item - $price"
                        const itemName = parts[0].trim();
                        const itemPrice = parseFloat(parts[1]?.replace('$', '').trim()) || 0; // Extract price

                        itemPrices[itemName] = itemPrice; // Store price

                        const checkboxItem = document.createElement("div");
                        checkboxItem.classList.add("form-check");

                        const checkboxInput = document.createElement("input");
                        checkboxInput.classList.add("form-check-input");
                        checkboxInput.type = "checkbox";
                        checkboxInput.id = `item${index}`;
                        checkboxInput.value = itemName;

                        const checkboxLabel = document.createElement("label");
                        checkboxLabel.classList.add("form-check-label");
                        checkboxLabel.setAttribute("for", `item${index}`);
                        checkboxLabel.innerText = itemName;

                        checkboxItem.appendChild(checkboxInput);
                        checkboxItem.appendChild(checkboxLabel);

                        receiptItems.appendChild(checkboxItem);
                    });

                    // Add animation class to simulate "receipt" appearing
                    receiptItems.classList.add("receipt-uploaded");
                })
                .catch(err => {
                    console.error("OCR Error: ", err);
                });
            }
        });

        // Handle group pay submission
        document.getElementById("groupPayBtn").addEventListener("click", function() {
            const selectedItems = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                       .map(checkbox => checkbox.value);
            if (selectedItems.length > 0) {
                // Calculate total amount
                let subtotal = selectedItems.reduce((total, item) => total + (itemPrices[item] || 0), 0);
                let tip = parseFloat(tipInput.value) || 0;
                let total = subtotal + tip;

                // Update the total amount display
                totalAmount.innerText = `Total: $${total.toFixed(2)}`;

                // Update the group selections display
                const groupSelectionsDiv = document.createElement('div');
                groupSelectionsDiv.innerHTML = `<strong>You selected:</strong> ${selectedItems.join(', ')}`;
                groupSelections.appendChild(groupSelectionsDiv);
            } else {
                alert("Please select at least one item from the receipt.");
            }
        });

        // Handle link sending
        document.getElementById("sendLinkBtn").addEventListener("click", function() {
            const contact = contactInput.value.trim();
            const selectedItems = Array.from(document.querySelectorAll("input[type='checkbox']:checked"))
                                       .map(checkbox => checkbox.value);

            if (contact && selectedItems.length > 0) {
                // Example link (you should generate a real link)
                const uniqueLink = `http://example.com/receipt?items=${encodeURIComponent(selectedItems.join(','))}`;

                // Simulate sending the link (you can implement a real email or SMS service)
                linkStatus.innerText = `Link sent to ${contact}: ${uniqueLink}`;
                contactInput.value = ''; // Clear input after sending
            } else {
                alert("Please enter a valid email or phone number and select items.");
            }
        });
    </script>
</body>
</html>
